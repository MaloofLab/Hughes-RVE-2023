---
title: "RVE Manuscript RVE8 Half-Life in ztl"
author: "Cassandra"
date: "2022-11-17"
output: html_document
editor_options: 
  chunk_output_type: inline
---

# Background

RVE8 protein degradation was assessed at ZT7 and ZT19 in monochromatic blue, monochromatic red, or constant dark light conditions.     

This was initially done in a WT background and is now being examined in a ztl mutant background.    

# Summary

In ztl background, significant difference in RVE8 deg rate (but not half-life) between ZT7 and ZT19 in constant blue light.      
No significant difference in RVE8 half-life (or deg rate) between ZT7 and ZT19 in constant red light or constant darkness.

```{r setup}
# for graphing
library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())

# for Bayesian analysis 
library(posterior)
library(brms)
```

```{r}
#setwd("C:/Users/contr/OneDrive - University of California, Davis/Harmer Lab/Manuscripts/RVE/Figures/figs6_ztl/")

#setwd("F:/OneDrive - University of California, Davis/Harmer Lab/Manuscripts/RVE/Figures/figS6_ztl/")
```

# RVE8 in ztl

## load and check data

```{r}
# load data
ztl <- read_csv("CHX_RVE8_ztl.csv")

# rename columns
colnames(ztl) <- c("exp", "blot", "label", "time", "zt", "light", "gt", "rep", "target", "abundance", "scaled", "zt_scaled")

# set factors, remove unnecessary columns
# also add exp_rep column to separate bio reps 
ztl <- ztl %>% 
  select(-c(blot, label, gt)) %>% 
  mutate(exp = as_factor(exp),
         zt = as_factor(zt),
         light = as_factor(light),
         target = as_factor(target),
         exp_rep = as_factor(paste0(exp, "_", rep)))
cat("\n")
summary(ztl)
```

```{r}
ztl %>% 
  ggplot(aes(time, zt_scaled, color = exp_rep)) +
  geom_point() + 
  geom_line(aes(linetype = exp_rep)) +
  scale_y_log10() + 
  facet_grid(zt ~ light)

ztl %>% 
  ggplot(aes(time, scaled, color = exp_rep)) +
  geom_point() + 
  geom_line(aes(linetype = exp_rep)) +
  scale_y_log10() + 
  facet_grid(zt ~ light)
```

Blue has 5 reps but Dark and Red only have 2 each.   

```{r}
# set up data subsets for each light quality
blue <- ztl %>% filter(light == "60B")
red <- ztl %>% filter(light == "60R")
dark <- ztl %>% filter(light == "DD")
```

## Blue

### fit and compare models

Set up a few models similar to initial RVE8 analysis.   

```{r cache = TRUE}
# first allow k and intercept to vary by ZT with random effect per rep 
frm1 <- bf(scaled ~ N0 * exp(-k*time),
           k + N0 ~ zt + (1|exp_rep),
           nl = TRUE)

# determine protein abundance at time 0 
N0 <- blue %>% filter(time == 0) %>% select(scaled)
# use mean to set priors
mean(N0$scaled)
sd(N0$scaled)

# assign priors
priors1 <- c(prior(normal(0.64, 0.5), nlpar = "N0", coef = "Intercept"), #prior = mean
             prior(normal(0, 0.5), nlpar = "N0", coef = "zt19"), #uninformative prior for ZT19 being different
             prior(normal(0, 1),nlpar = "k", lb=0), #uninformative prior for rate, constrain positive
             prior(cauchy(0, 1), class = sigma),
             prior(cauchy(0, 1), class = sd, nlpar = "N0"),
             prior(cauchy(0, 1), class = sd, nlpar = "k"))

# fit model 
fit1b <- brm(formula = frm1,
             prior = priors1,
             data = blue,
             cores = 4,
             iter = 24000,
             control = list(adapt_delta = 0.99))
```

```{r}
# check model 
summary(fit1b)

plot(fit1b, ask = FALSE)
```

Rhat = 1, so parameter space was sampled well. Diagnostic plots look okay.   

```{r cache = TRUE}
# no random effect for N0
frm2 <- bf(scaled ~ N0 * exp(-k*time),
           k ~ zt + (1|exp_rep),
           N0 ~ zt,
           nl = TRUE)

# similar priors as before 
priors2 <- c(prior(normal(0.64, 0.5), nlpar = "N0", coef = "Intercept"), #prior = mean
             prior(normal(0, 0.5), nlpar = "N0", coef = "zt19"), #uninformative prior for ZT19 being different
             prior(normal(0, 1), nlpar = "k", lb=0), #uninformative prior for rate, constrain positive
             prior(cauchy(0, 1), class = sigma),
             prior(cauchy(0, 1), class = sd, nlpar = "k"))

# fit second model 
fit2b <- brm(formula = frm2,
             prior = priors2,
             data = blue,
             cores = 4,
             iter = 24000,
             control = list(adapt_delta = 0.99))
```

```{r}
# check model 
summary(fit2b)

plot(fit2b, ask = FALSE)
```

Rhat = 1, plots look okay.    

```{r cache = TRUE}
# no random effect for N0 or k
frm3 <- bf(scaled ~ N0 * exp(-k*time),
           k + N0 ~ zt,
           nl = TRUE)

# similar priors again
priors3 <- c(prior(normal(0.64, 0.5), nlpar = "N0", coef = "Intercept"), #prior = mean
             prior(normal(0, 0.5), nlpar = "N0", coef = "zt19"), #uninformative prior for ZT19 being different
             prior(normal(0, 1), nlpar = "k", lb=0), #uninformative prior for rate, constrain positive
             prior(cauchy(0, 1), class = sigma))

# fit third model 
fit3b <- brm(formula = frm3,
             prior = priors3,
             data = blue,
             cores = 4,
             iter = 16000,
             control = list(adapt_delta = 0.9))
```

```{r}
# check model 
summary(fit3b)

plot(fit3b, ask = FALSE)
```

Rhat = 1, plots look okay.   

```{r}
# compare the three models
LOO(fit1b, fit2b, fit3b)
```

Second model has the best fit, but fit 3b is close.   
Go with the simple third model.   

### compare deg rate between ZT7 and ZT19

```{r}
# is ZT19 deg rate significantly different from ZT7 deg rate?
hyp1 <- hypothesis(fit3b, hypothesis = "k_Intercept + k_zt19 = k_Intercept")
hyp1

plot(hyp1)

# check posterior samples of deg rate at ZT19 
k19 <- as_draws_array(fit3b, "b_k_zt19")
summarize_draws(k19)
mean(k19 <= 0) # proportion of posterior samples with k_zt19 <= 0
```

Looks like ZT19 deg rate is significantly different from ZT7 deg rate.   
Only 0.03% of posterior samples are <= 0, so deg rate at ZT7 likely different from deg rate at ZT19.   

### calculate half-lives and compare between ZT7 and ZT19

```{r}
# first get coefficients
coefs <- fixef(fit3b)[, "Estimate"]

#for ZT7
log(2) / coefs["k_Intercept"]

#for ZT19
log(2) / sum(coefs["k_Intercept"], coefs["k_zt19"])
```

```{r}
# is ZT19 half-life significantly different from ZT7 half-life?
hyp2 <- hypothesis(fit3b, hypothesis = "(log(2) / k_Intercept) = (log(2) / (k_Intercept + k_zt19))", robust = TRUE)
hyp2

plot(hyp2)
```

ZT19 half-life is significantly different from ZT7 half-life     

### fit and compare models with fixed N0

Set up a few models similar to initial RVE8 analysis.   

```{r cache = TRUE}
# first allow k and intercept to vary by ZT with random effect per rep 
frm4 <- bf(scaled ~ N0 * exp(-k*time),
           k ~ zt + (1|exp_rep),
           N0 ~ (1|exp_rep),
           nl = TRUE)

# determine protein abundance at time 0 
N0 <- blue %>% filter(time == 0) %>% select(scaled)
# use mean to set priors
mean(N0$scaled)
sd(N0$scaled)

# assign priors
priors4 <- c(prior(normal(0.64, 0.5), nlpar = "N0", coef = "Intercept"), #prior = mean
             prior(normal(0, 1), nlpar = "k", lb=0), #uninformative prior for rate, constrain positive
             prior(cauchy(0, 1), class = sigma),
             prior(cauchy(0, 1), class = sd, nlpar = "N0"),
             prior(cauchy(0, 1), class = sd, nlpar = "k"))

# fit model 
fit4b <- brm(formula = frm4,
             prior = priors4,
             data = blue,
             cores = 4,
             iter = 24000,
             control = list(adapt_delta = 0.99))
```

```{r}
# check model 
summary(fit4b)

plot(fit4b, ask = FALSE)
```

Rhat = 1, so parameter space was sampled well. Diagnostic plots look okay.   

```{r cache = TRUE}
# no random effect for N0
frm5 <- bf(scaled ~ N0 * exp(-k*time),
           k ~ zt + (1|exp_rep),
           N0 ~ 1,
           nl = TRUE)

# similar priors as before 
priors5 <- c(prior(normal(0.64, 0.5), nlpar = "N0", coef = "Intercept"), #prior = mean
             prior(normal(0, 1), nlpar = "k", lb=0), #uninformative prior for rate, constrain positive
             prior(cauchy(0, 1), class = sigma),
             prior(cauchy(0, 1), class = sd, nlpar = "k"))

# fit second model 
fit5b <- brm(formula = frm5,
             prior = priors5,
             data = blue,
             cores = 4,
             iter = 24000,
             control = list(adapt_delta = 0.99))
```

```{r}
# check model 
summary(fit5b)

plot(fit5b, ask = FALSE)
```

Rhat = 1, plots look okay.    

```{r cache = TRUE}
# no random effect for N0 or k
frm6 <- bf(scaled ~ N0 * exp(-k*time),
           k ~ zt,
           N0 ~ 1,
           nl = TRUE)

# similar priors again
priors6 <- c(prior(normal(0.64, 0.5), nlpar = "N0", coef = "Intercept"), #prior = mean
             prior(normal(0, 1), nlpar = "k", lb=0), #uninformative prior for rate, constrain positive
             prior(cauchy(0, 1), class = sigma))

# fit third model 
fit6b <- brm(formula = frm6,
             prior = priors6,
             data = blue,
             cores = 4,
             iter = 16000,
             control = list(adapt_delta = 0.9))
```

```{r}
# check model 
summary(fit6b)

plot(fit6b, ask = FALSE)
```

Rhat = 1, plots look okay.   

```{r}
# compare the three models
LOO(fit4b, fit5b, fit6b)
``` 

6b  has the best fit, 5b is almost the same; 4b a little worse. Go with 6b  
Go with the simple third model.   

### compare deg rate between ZT7 and ZT19

```{r}
# is ZT19 deg rate significantly different from ZT7 deg rate?
hyp1 <- hypothesis(fit6b, hypothesis = "k_Intercept + k_zt19 = k_Intercept")
hyp1

plot(hyp1)

# check posterior samples of deg rate at ZT19 
k19 <- as_draws_array(fit6b, "b_k_zt19")
summarize_draws(k19)
mean(k19 <= 0) # proportion of posterior samples with k_zt19 <= 0
```

Looks like ZT19 deg rate is significantly different from ZT7 deg rate.   
Only 0.03% of posterior samples are <= 0, so deg rate at ZT7 likely different from deg rate at ZT19.   

### calculate half-lives and compare between ZT7 and ZT19

```{r}
# first get coefficients
coefs <- fixef(fit6b)[, "Estimate"]

#for ZT7
log(2) / coefs["k_Intercept"]

#for ZT19
log(2) / sum(coefs["k_Intercept"], coefs["k_zt19"])
```

```{r}
# is ZT19 half-life significantly different from ZT7 half-life?
hyp2 <- hypothesis(fit6b, hypothesis = "(log(2) / k_Intercept) = (log(2) / (k_Intercept + k_zt19))", robust = TRUE)
hyp2

plot(hyp2)
```
significant!


## Red 

### fit and compare models

Set up a few models like with Blue data. Can just update the blue models with new data.            

```{r cache = TRUE}
# update fit1b model 
fit1r <- update(fit1b, newdata = red)
```

```{r}
# check model 
summary(fit1r)

plot(fit1r, ask = FALSE)
```

Rhat = 1, so parameter space was sampled well. Diagnostic plots look okay.   

```{r cache = TRUE}
# update fit2b model
fit2r <- update(fit2b, newdata = red)
```

```{r}
# check model 
summary(fit2r)

plot(fit2r, ask = FALSE)
```

Rhat = 1, plots look okay.    

```{r cache = TRUE}
# update fit3b model
fit3r <- update(fit3b, newdata = red)
```

```{r}
# check model 
summary(fit3r)

plot(fit3r, ask = FALSE)
```

Rhat = 1, plots look okay.   

```{r}
# compare the three models
LOO(fit1r, fit2r, fit3r)
```

First model has the best fit but all models still seem comparable?    
Again, go with simple third model.    

### compare deg rate between ZT7 and ZT19

```{r}
# is ZT19 deg rate significantly different from ZT7 deg rate?
hyp1 <- hypothesis(fit3r, hypothesis = "k_Intercept + k_zt19 = k_Intercept")
hyp1

plot(hyp1)

# check posterior samples of deg rate at ZT19 
k19 <- as_draws_array(fit3r, "b_k_zt19")
summarize_draws(k19)
mean(k19 <= 0) # proportion of posterior samples with k_zt19 <= 0
```

In constant red light, ZT19 deg rate is not significantly different from ZT7 deg rate.   
~14% of posterior samples are <= 0.   

### calculate half-lives and compare between ZT7 and ZT19

```{r}
# first get coefficients
coefs <- fixef(fit3r)[, "Estimate"]

#for ZT7
log(2) / coefs["k_Intercept"]

#for ZT19
log(2) / sum(coefs["k_Intercept"], coefs["k_zt19"])
```

```{r}
# is ZT19 half-life significantly different from ZT7 half-life?
hyp2 <- hypothesis(fit3r, hypothesis = "(log(2) / k_Intercept) = (log(2) / (k_Intercept + k_zt19))")
hyp2

plot(hyp2)
```

ZT19 half-life is not significantly different from ZT7 half-life with Bayesian confidence interval of 0.05.        
Consistent with no significant difference in deg rates.    

## Dark

### fit and compare models

Again, update the blue models with new data.            

```{r dark1}
# update fit1b model  
fit1d <- update(fit1b, newdata = dark)
```

```{r}
# check model 
summary(fit1d)

plot(fit1d, ask = FALSE)
```

Rhat = 1, so parameter space was sampled well. Diagnostic plots look okay.   

```{r dark2}
# update fit2b model
fit2d <- update(fit2b, newdata = dark)
```

```{r}
# check model 
summary(fit2d)

plot(fit2d, ask = FALSE)
```

Rhat = 1, plots look okay.    

```{r dark3}
# update fit3b model
fit3d <- update(fit3b, newdata = dark)
```

```{r}
# check model 
summary(fit3d)

plot(fit3d, ask = FALSE)
```

Rhat = 1, plots look okay.   

```{r}
# compare the three models
LOO(fit1d, fit2d, fit3d)
```

First model has the best fit. First and second model seem comparable but third model isn't great?     
Go with second model. Maybe check out third model for comparison.       

### compare deg rate between ZT7 and ZT19

```{r}
# is ZT19 deg rate significantly different from ZT7 deg rate?
hyp1 <- hypothesis(fit2d, hypothesis = "k_Intercept + k_zt19 = k_Intercept")
hyp1

plot(hyp1)

# check posterior samples of deg rate at ZT19 
k19 <- as_draws_array(fit2d, "b_k_zt19")
summarize_draws(k19)
mean(k19 <= 0) # proportion of posterior samples with k_zt19 <= 0
```

```{r}
# look at third model 
hyp1 <- hypothesis(fit3d, hypothesis = "k_Intercept + k_zt19 = k_Intercept")
hyp1

plot(hyp1)
```

In constant darkness, ZT19 deg rate is not significantly different from ZT7 deg rate.   

### calculate half-lives and compare between ZT7 and ZT19

```{r}
# first get coefficients
coefs <- fixef(fit2d)[, "Estimate"]

#for ZT7
log(2) / coefs["k_Intercept"]

#for ZT19
log(2) / sum(coefs["k_Intercept"], coefs["k_zt19"])
```

```{r}
# is ZT19 half-life significantly different from ZT7 half-life?
hyp2 <- hypothesis(fit2d, hypothesis = "(log(2) / k_Intercept) = (log(2) / (k_Intercept + k_zt19))")
hyp2

plot(hyp2)
```

```{r}
# look at third model
coefs <- fixef(fit3d)[, "Estimate"]

#for ZT7
log(2) / coefs["k_Intercept"]

#for ZT19
log(2) / sum(coefs["k_Intercept"], coefs["k_zt19"])
```

```{r}
# is ZT19 half-life significantly different from ZT7 half-life?
hyp2 <- hypothesis(fit3d, hypothesis = "(log(2) / k_Intercept) = (log(2) / (k_Intercept + k_zt19))")
hyp2

plot(hyp2)
```

ZT19 half-life is not significantly different from ZT7 half-life with Bayesian confidence interval of 0.05.        
Consistent with no significant difference in deg rates.   