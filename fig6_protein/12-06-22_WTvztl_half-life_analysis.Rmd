---
title: "RVE Manuscript WT v ztl Half-Life for RVE8"
author: "Cassandra"
date: "2022-11-18"
output: html_document
editor_options: 
  chunk_output_type: inline
---

# Background

RVE8 protein degradation was assessed at ZT7 and ZT19 in monochromatic blue, monochromatic red, or constant dark light conditions. This was done both in a WT background and a *ztl* mutant background.       

Stacey suggested comparing the half-life of RVE8 between the WT and *ztl* backgrounds in constant blue light at a single time point (ZT7 or ZT19).    

# Summary

At ZT7 in constant blue light, there is a significant difference between RVE8 deg rate (but not half-life) in WT background and *ztl* background.    
At ZT19 in constant blue light, there is no significant difference between RVE8 deg rate (or half-life) in WT background and *ztl* background.     

```{r setup}
# for graphing
library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())

# for Bayesian analysis 
library(posterior)
library(brms)
```

```{r}
#setwd("C:/Users/contr/OneDrive - University of California, Davis/Harmer Lab/Manuscripts/RVE/Figures/fig6_protein/")

#setwd("F:/OneDrive - University of California, Davis/Harmer Lab/Manuscripts/RVE/Figures/fig6_protein/")
```

# RVE8 WT vs ztl  

## load and check data

```{r}
# load data
wt <- read_csv("CHX_RVE8_WT.csv")
ztl <- read_csv("CHX_RVE8_ztl.csv")

# join data frames together
rve8 <- full_join(wt, ztl)

# rename columns
colnames(rve8) <- c("exp", "blot", "label", "time", "zt", "light", "gt", "rep", "target", "abundance", "scaled", "zt_scaled")

# set factors, remove unnecessary columns
# also add exp_rep column to separate bio reps 
rve8 <- rve8 %>% 
  select(-c(blot, label)) %>% 
  mutate(exp = as_factor(exp),
         zt = as_factor(zt),
         light = as_factor(light),
         gt = as_factor(gt),
         target = as_factor(target),
         exp_rep = as_factor(paste0(exp, "_", rep)))

summary(rve8)
```

```{r}
rve8 %>% 
  ggplot(aes(time, zt_scaled, color = gt)) +
  geom_point() + 
  geom_line(aes(linetype = exp_rep)) +
  scale_y_log10() + 
  facet_grid(zt ~ light)

rve8 %>% 
  ggplot(aes(time, scaled, color = gt)) +
  geom_point() + 
  geom_line(aes(linetype = exp_rep)) +
  scale_y_log10() + 
  facet_grid(zt ~ light)
```

```{r}
# set up data subsets for each zt with blue data 
zt7b <- rve8 %>% filter(zt == "7", light == "60B")
summary(zt7b)

zt19b <- rve8 %>% filter(zt == "19", light == "60B")
summary(zt19b)

# red subsets
zt7r <- rve8 %>% filter(zt == "7", light == "60R")
summary(zt7r)

zt19r <- rve8 %>% filter(zt == "19", light == "60R")
summary(zt19r)

# dark subsets
zt7d <- rve8 %>% filter(zt == "7", light == "DD")
summary(zt7d)

zt19d <- rve8 %>% filter(zt == "19", light == "DD")
summary(zt19d)
```

## Blue

### ZT7

#### fit and compare models

Use non-linear formula and set priors similar to initial RVE8 analysis.   

```{r}
# first allow k and intercept to vary by genotype with random effect per rep 
frm1 <- bf(zt_scaled ~ N0 * exp(-k*time),
           k + N0 ~ gt + (1|exp_rep),
           nl = TRUE)

# determine protein abundance at time 0 
N0 <- zt7b %>% filter(time == 0) %>% select(zt_scaled)
# use mean to set priors
mean(N0$zt_scaled)
sd(N0$zt_scaled)

# assign priors
priors1 <- c(prior(normal(0.87, 0.5), nlpar = "N0", coef = "Intercept"), #prior = mean
             prior(normal(0, 0.5), nlpar = "N0", coef = "gtztl"), #uninformative prior for ztl being different
             prior(normal(0, 1),nlpar = "k"), #uninformative prior for rate
             prior(cauchy(0, 1), class = sigma),
             prior(cauchy(0, 1), class = sd, nlpar = "N0"),
             prior(cauchy(0, 1), class = sd, nlpar = "k"))

# fit model 
fit1zt7 <- brm(formula = frm1,
             prior = priors1,
             data = zt7b,
             cores = 4,
             iter = 24000,
             control = list(adapt_delta = 0.99))
```

```{r}
# check model 
summary(fit1zt7)

plot(fit1zt7, ask = FALSE)
```

Rhat = 1, so parameter space was sampled well. Diagnostic plots look okay.   

```{r}
# no random effect for N0
frm2 <- bf(scaled ~ N0 * exp(-k*time),
           k ~ gt + (1|exp_rep),
           N0 ~ gt,
           nl = TRUE)

# similar priors as before 
priors2 <- c(prior(normal(0.87, 0.5), nlpar = "N0", coef = "Intercept"), #prior = mean
             prior(normal(0, 0.5), nlpar = "N0", coef = "gtztl"), #uninformative prior for ztl being different
             prior(normal(0, 1),nlpar = "k"), #uninformative prior for rate
             prior(cauchy(0, 1), class = sigma),
             prior(cauchy(0, 1), class = sd, nlpar = "k"))

# fit second model 
fit2zt7 <- brm(formula = frm2,
             prior = priors2,
             data = zt7b,
             cores = 4,
             iter = 24000,
             control = list(adapt_delta = 0.99))
```

```{r}
# check model 
summary(fit2zt7)

plot(fit2zt7, ask = FALSE)
```

Rhat = 1, plots look okay.    

```{r}
# no random effect for N0 or k
frm3 <- bf(scaled ~ N0 * exp(-k*time),
           k + N0 ~ gt,
           nl = TRUE)

# similar priors again
priors3 <- c(prior(normal(0.87, 0.5), nlpar = "N0", coef = "Intercept"), #prior = mean
             prior(normal(0, 0.5), nlpar = "N0", coef = "gtztl"), #uninformative prior for ztl being different
             prior(normal(0, 1),nlpar = "k"), #uninformative prior for rate
             prior(cauchy(0, 1), class = sigma))

# fit third model 
fit3zt7 <- brm(formula = frm3,
             prior = priors3,
             data = zt7b,
             cores = 4,
             iter = 16000,
             control = list(adapt_delta = 0.9))
```

```{r}
# check model 
summary(fit3zt7)

plot(fit3zt7, ask = FALSE)
```

Rhat = 1, plots look okay.   

```{r}
# compare the three models
LOO(fit1zt7, fit2zt7, fit3zt7)
```

Second model has the best fit, but the three models are comparable?    
Go with the simple third model.   

#### compare deg rate between WT and ztl

```{r}
# is WT deg rate significantly different from ztl deg rate?
hyp1 <- hypothesis(fit3zt7, hypothesis = "k_Intercept + k_gtztl < k_Intercept")
hyp1

plot(hyp1)

# check posterior samples of deg rate in ztl 
kztl <- as_draws_array(fit3zt7, "b_k_gtztl")
summarize_draws(kztl)
mean(kztl <= 0) # proportion of posterior samples with k_gtztl <= 0
```

Looks like WT deg rate is significantly different from *ztl* deg rate at ZT7.   

#### calculate half-lives and compare between WT and ztl 

```{r}
# first get coefficients
coefs <- fixef(fit3zt7)[, "Estimate"]

#for WT
log(2) / coefs["k_Intercept"]

#for ztl
log(2) / sum(coefs["k_Intercept"], coefs["k_gtztl"])
```

Half-lives are pretty consistent with previous calculations.   

```{r}
# is WT half-life significantly different from ztl half-life?
hyp2 <- hypothesis(fit3zt7, hypothesis = "(log(2) / k_Intercept) < (log(2) / (k_Intercept + k_gtztl))")
hyp2

#plot(hyp2)
```

WT half-life is not significantly different from ztl half-life with Bayesian confidence interval of 0.05.        
**Not consistent with deg rates, but error here is quite large.**        

### ZT19 

#### fit and compare models

Set up a few models like with ZT7 data. Can just update models with new data.            

```{r}
# update fit1 model 
fit1zt19 <- update(fit1zt7, newdata = zt19b, cores=4)
```

```{r}
# check model 
summary(fit1zt19)

plot(fit1zt19, ask = FALSE)
```

Rhat = 1, so parameter space was sampled well. Diagnostic plots look okay.   

```{r}
# update fit2 model
fit2zt19 <- update(fit2zt7, newdata = zt19b, cores=4)
```

```{r}
# check model 
summary(fit2zt19)

plot(fit2zt19, ask = FALSE)
```

Rhat = 1, plots look okay.    

```{r}
# update fit3 model
fit3zt19 <- update(fit3zt7, newdata = zt19b, sample_prior = "yes", cores=4)
```

```{r}
# check model 
summary(fit3zt19)

plot(fit3zt19, ask = FALSE)
```

Rhat = 1, plots look okay.   

```{r}
# compare the three models
LOO(fit1zt19, fit2zt19, fit3zt19)
```

First model has the best fit but all models still seem comparable?    
Go with simple third model.    

#### compare deg rate between WT and ztl

```{r}
# is WT deg rate significantly different from ztl deg rate at ZT19?
hyp1 <- hypothesis(fit3zt19, hypothesis = " k_gtztl > 0")
hyp1

plot(hyp1)

# check posterior samples of deg rate in ztl 
kztl <- as_draws_array(fit3zt19, "b_k_gtztl")
summarize_draws(kztl)
mean(kztl <= 0) # proportion of posterior samples with k_gtztl <= 0
```

At ZT19, Wt deg rate is not significantly different from *ztl* deg rate.   

#### calculate half-lives and compare between WT and ztl 

```{r}
# first get coefficients
coefs <- fixef(fit3zt19)[, "Estimate"]

#for WT
log(2) / coefs["k_Intercept"]

#for ztl
log(2) / sum(coefs["k_Intercept"], coefs["k_gtztl"])
```

Half-lives are again consistent with previous calculations.    

```{r}
# is WT half-life significantly different from ztl half-life?
hyp2 <- hypothesis(fit3zt19, hypothesis = "(log(2) / k_Intercept) = (log(2) / (k_Intercept + k_gtztl))")
hyp2

plot(hyp2)
```

At ZT19, WT half-life is not significantly different from *ztl* half-life with Bayesian confidence interval of 0.05.        
Consistent with no significant difference in deg rates.  




## Red

### ZT7

#### fit and compare models

Use non-linear formula and set priors similar to initial RVE8 analysis.   

```{r}
# update fit1 model 
fit1zt7r <- update(fit1zt7, newdata = zt7r)
```

```{r}
# check model 
summary(fit1zt7r)

plot(fit1zt7r, ask = FALSE)
```

Rhat = 1, so parameter space was sampled well. Diagnostic plots look okay.   

```{r}
# update fit2 model 
fit2zt7r <- update(fit2zt7, newdata = zt7r)
```

```{r}
# check model 
summary(fit2zt7r)

plot(fit2zt7r, ask = FALSE)
```

Rhat = 1, plots look okay.    

```{r}
# update fit3 model 
fit3zt7r <- update(fit3zt7, newdata = zt7r)
```

```{r}
# check model 
summary(fit3zt7r)

plot(fit3zt7r, ask = FALSE)
```

Rhat = 1, plots look okay.   

```{r}
# compare the three models
LOO(fit1zt7r, fit2zt7r, fit3zt7r)
```

Second model has the best fit, but the three models are comparable?    
Go with the simple third model.   

#### compare deg rate between blue and red light

```{r}
# is WT deg rate significantly different from ztl deg rate?
hyp1 <- hypothesis(fit3zt7r, hypothesis = "k_Intercept + k_gtztl = k_Intercept")
hyp1

plot(hyp1)

# check posterior samples of deg rate in ztl 
kztl <- as_draws_array(fit3zt7r, "b_k_gtztl")
summarize_draws(kztl)
mean(kztl <= 0) # proportion of posterior samples with k_gtztl <= 0
```

Looks like WT deg rate is not significantly different from *ztl* deg rate at ZT7 in red light.   

#### calculate half-lives and compare between WT and ztl 

```{r}
# first get coefficients
coefs <- fixef(fit3zt7r)[, "Estimate"]

#for WT
log(2) / coefs["k_Intercept"]

#for ztl
log(2) / sum(coefs["k_Intercept"], coefs["k_gtztl"])
```

Half-lives are pretty consistent with previous calculations.   

```{r}
# is WT half-life significantly different from ztl half-life?
hyp2 <- hypothesis(fit3zt7r, hypothesis = "(log(2) / k_Intercept) = (log(2) / (k_Intercept + k_gtztl))")
hyp2

plot(hyp2)
```

WT half-life is not significantly different from ztl half-life with Bayesian confidence interval of 0.05.        

### ZT19 

#### fit and compare models

Set up a few models like with ZT7 data. Can just update models with new data.            

```{r}
# update fit1 model 
fit1zt19r <- update(fit1zt7, newdata = zt19r)
```

```{r}
# check model 
summary(fit1zt19r)

plot(fit1zt19r, ask = FALSE)
```

Rhat = 1, so parameter space was sampled well. Diagnostic plots look okay.   

```{r}
# update fit2 model
fit2zt19r <- update(fit2zt7, newdata = zt19r)
```

```{r}
# check model 
summary(fit2zt19r)

plot(fit2zt19r, ask = FALSE)
```

Rhat = 1, plots look okay.    

```{r}
# update fit3 model
fit3zt19r <- update(fit3zt7, newdata = zt19r)
```

```{r}
# check model 
summary(fit3zt19r)

plot(fit3zt19r, ask = FALSE)
```

Rhat = 1, plots look okay.   

```{r}
# compare the three models
LOO(fit1zt19r, fit2zt19r, fit3zt19r)
```

First model has the best fit and seems the best.     

#### compare deg rate between WT and ztl

```{r}
# is WT deg rate significantly different from ztl deg rate at ZT19?
hyp1 <- hypothesis(fit1zt19r, hypothesis = "k_Intercept + k_gtztl = k_Intercept")
hyp1

plot(hyp1)

# check posterior samples of deg rate in ztl 
kztl <- as_draws_array(fit1zt19r, "b_k_gtztl")
summarize_draws(kztl)
mean(kztl <= 0) # proportion of posterior samples with k_gtztl <= 0
```

At ZT19, WT deg rate is not significantly different from *ztl* deg rate in constant red light.   

#### calculate half-lives and compare between WT and ztl 

```{r}
# first get coefficients
coefs <- fixef(fit1zt19r)[, "Estimate"]

#for WT
log(2) / coefs["k_Intercept"]

#for ztl
log(2) / sum(coefs["k_Intercept"], coefs["k_gtztl"])
```

Half-lives are pretty consistent with previous calculations.    

```{r}
# is WT half-life significantly different from ztl half-life?
hyp2 <- hypothesis(fit1zt19r, hypothesis = "(log(2) / k_Intercept) = (log(2) / (k_Intercept + k_gtztl))")
hyp2

plot(hyp2)
```

At ZT19, WT half-life is not significantly different from *ztl* half-life with Bayesian confidence interval of 0.05.        
Consistent with no significant difference in deg rates.  

## Dark

### ZT7

#### fit and compare models

Use non-linear formula and set priors similar to initial RVE8 analysis.   

```{r}
# update fit1 model 
fit1zt7d <- update(fit1zt7, newdata = zt7d)
```

```{r}
# check model 
summary(fit1zt7d)

plot(fit1zt7d, ask = FALSE)
```

Rhat = 1, so parameter space was sampled well. Diagnostic plots look okay.   

```{r}
# update fit2 model 
fit2zt7d <- update(fit2zt7, newdata = zt7d)
```

```{r}
# check model 
summary(fit2zt7d)

plot(fit2zt7d, ask = FALSE)
```

Rhat = 1, plots look okay.    

```{r}
# update fit3 model 
fit3zt7d <- update(fit3zt7, newdata = zt7d)
```

```{r}
# check model 
summary(fit3zt7d)

plot(fit3zt7d, ask = FALSE)
```

Rhat = 1, plots look okay.   

```{r}
# compare the three models
LOO(fit1zt7d, fit2zt7d, fit3zt7d)
```

Second model has the best fit, but third model seems comparable?    
Go with the simple third model.   

#### compare deg rate between blue and red light

```{r}
# is WT deg rate significantly different from ztl deg rate?
hyp1 <- hypothesis(fit3zt7d, hypothesis = "k_Intercept + k_gtztl = k_Intercept")
hyp1

plot(hyp1)

# check posterior samples of deg rate in ztl 
kztl <- as_draws_array(fit3zt7d, "b_k_gtztl")
summarize_draws(kztl)
mean(kztl <= 0) # proportion of posterior samples with k_gtztl <= 0
```

Looks like WT deg rate is not significantly different from *ztl* deg rate at ZT7 in constant darkness.   

#### calculate half-lives and compare between WT and ztl 

```{r}
# first get coefficients
coefs <- fixef(fit3zt7d)[, "Estimate"]

#for WT
log(2) / coefs["k_Intercept"]

#for ztl
log(2) / sum(coefs["k_Intercept"], coefs["k_gtztl"])
```

Half-lives are pretty consistent with previous calculations.   

```{r}
# is WT half-life significantly different from ztl half-life?
hyp2 <- hypothesis(fit3zt7d, hypothesis = "(log(2) / k_Intercept) = (log(2) / (k_Intercept + k_gtztl))")
hyp2

plot(hyp2)
```

WT half-life is not significantly different from ztl half-life with Bayesian confidence interval of 0.05.        

### ZT19 

#### fit and compare models

Set up a few models like with ZT7 data. Can just update models with new data.            

```{r}
# update fit1 model 
fit1zt19d <- update(fit1zt7, newdata = zt19d)
```

```{r}
# check model 
summary(fit1zt19d)

plot(fit1zt19d, ask = FALSE)
```

Rhat = 1, so parameter space was sampled well. Diagnostic plots look okay.   

```{r}
# update fit2 model
fit2zt19d <- update(fit2zt7, newdata = zt19d)
```

```{r}
# check model 
summary(fit2zt19d)

plot(fit2zt19d, ask = FALSE)
```

Rhat = 1, plots look okay.    

```{r}
# update fit3 model
fit3zt19d <- update(fit3zt7, newdata = zt19d)
```

```{r}
# check model 
summary(fit3zt19d)

plot(fit3zt19d, ask = FALSE)
```

Rhat = 1, plots look okay.   

```{r}
# compare the three models
LOO(fit1zt19d, fit2zt19d, fit3zt19d)
```

First model has the best fit but all models seem comparable.     
Use third model.   

#### compare deg rate between WT and ztl

```{r}
# is WT deg rate significantly different from ztl deg rate at ZT19?
hyp1 <- hypothesis(fit3zt19d, hypothesis = "k_Intercept + k_gtztl = k_Intercept")
hyp1

plot(hyp1)

# check posterior samples of deg rate in ztl 
kztl <- as_draws_array(fit3zt19d, "b_k_gtztl")
summarize_draws(kztl)
mean(kztl <= 0) # proportion of posterior samples with k_gtztl <= 0
```

At ZT19, WT deg rate is not significantly different from *ztl* deg rate in constant darkness.   

#### calculate half-lives and compare between WT and ztl 

```{r}
# first get coefficients
coefs <- fixef(fit3zt19d)[, "Estimate"]

#for WT
log(2) / coefs["k_Intercept"]

#for ztl
log(2) / sum(coefs["k_Intercept"], coefs["k_gtztl"])
```

Half-lives are pretty consistent with previous calculations.    

```{r}
# is WT half-life significantly different from ztl half-life?
hyp2 <- hypothesis(fit3zt19d, hypothesis = "(log(2) / k_Intercept) = (log(2) / (k_Intercept + k_gtztl))")
hyp2

plot(hyp2)
```

At ZT19, WT half-life is not significantly different from *ztl* half-life with Bayesian confidence interval of 0.05.        
Consistent with no significant difference in deg rates.  
